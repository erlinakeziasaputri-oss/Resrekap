<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResRekap - Sistem Rekap Digital</title>
    
    <!-- 0. PENANGAN ERROR DARURAT -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            if(message.includes("ResizeObserver")) return;
            document.body.innerHTML = `
                <div style="padding: 20px; font-family: sans-serif; color: #333; text-align: center; margin-top: 50px;">
                    <h2 style="color: #ef4444;">Terjadi Kesalahan Sistem</h2>
                    <p>Aplikasi mengalami masalah saat memuat.</p>
                    <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: left; font-family: monospace; font-size: 12px; margin: 20px auto; max-width: 600px; border: 1px solid #cbd5e1;">
                        <strong>Pesan:</strong> ${message}<br>
                        <strong>Lokasi:</strong> Baris ${lineno}
                    </div>
                    <button onclick="window.location.reload()" style="background: #0f172a; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Muat Ulang Halaman</button>
                </div>
            `;
            return true;
        };
    </script>

    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. Load html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- 6. FIREBASE SDK & CONFIGURATION -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCMrpygBZspSkjHR03xpBCiSKe59D63hyI",
            authDomain: "resrekap24.firebaseapp.com",
            projectId: "resrekap24",
            storageBucket: "resrekap24.firebasestorage.app",
            messagingSenderId: "464920670253",
            appId: "1:464920670253:web:b783ced39ce42e9ca288a4"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Global Variables for React to Access
            window.db = db;
            window.auth = auth;
            window.firebaseHelpers = { signInAnonymously, onAuthStateChanged, doc, setDoc, onSnapshot, collection };
            
            console.log("Firebase initialized successfully");

            // --- FITUR TES KONEKSI (DIBUNGKUS ASYNC AGAR TIDAK ERROR/BLANK) ---
            (async () => {
                console.log("Mencoba koneksi database...");
                try {
                    // Gunakan try-catch senyap agar tidak mengganggu UI utama
                    const docRef = await addDoc(collection(db, "tes_koneksi"), {
                        pesan: "Halo Firebase, ini tes koneksi dari ResRekap",
                        waktu: new Date()
                    });
                    console.log("SUKSES TES KONEKSI! ID Data: ", docRef.id);
                } catch (e) {
                    console.warn("Info: Tes koneksi background gagal (tidak fatal):", e.message);
                }
            })();
        } catch (err) {
            console.error("Firebase Init Error:", err);
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        @keyframes float-slow {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }
        .animate-float-slow { animation: float-slow 10s ease-in-out infinite; }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow { animation: spin-slow 20s linear infinite; }

        /* Scrollbar Refinement */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }

        /* PDF Styles */
        #pdf-fullscreen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #1e293b; 
            z-index: 9000; 
            overflow-y: auto;
            display: flex;
            justify-content: center;
            padding: 40px 0; 
            align-items: flex-start;
        }

        #pdf-content {
            width: 210mm; 
            min-height: 297mm; 
            background: white;
            padding: 15mm 10mm; 
            box-sizing: border-box; 
            color: #000; 
            font-family: 'Times New Roman', serif; 
            position: relative;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        #pdf-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255,255,255,0.9);
            z-index: 10000; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
            margin-bottom: 20px;
        }
        .pdf-table th {
            border: 1px solid #000;
            background-color: #f1f5f9; 
            padding: 8px 6px;
            font-weight: bold;
            text-transform: uppercase;
            color: #000;
        }
        .pdf-table td {
            border: 1px solid #000;
            padding: 6px; 
            vertical-align: middle;
            color: #000;
        }
        
        .preview-modal-content {
            width: 215mm; 
            max-width: 95vw;
            height: 85vh;
            background: #334155;
            overflow-y: auto;
            border-radius: 12px;
            padding: 30px;
            display: flex;
            justify-content: center;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }
        
        .bg-grid-pattern {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(139, 92, 246, 0.05) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(139, 92, 246, 0.05) 1px, transparent 1px);
        }

        /* Loading Indicator for Firebase */
        .db-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: #fff;
            padding: 8px 16px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #e2e8f0;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-syncing { background: #f59e0b; animation: pulse 1s infinite; }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-error { background: #ef4444; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 h-screen overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel">
        // --- UTILS & ICONS ---
        const IconBridge = ({ name, size = 20, className = "", ...props }) => {
            if (typeof lucide === 'undefined') return null;
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return React.createElement('svg', {
                ...props, width: size, height: size, viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: 2,
                strokeLinecap: "round", strokeLinejoin: "round",
                className: `lucide lucide-${name} ${className}`,
            }, ...iconData.map(([tag, attrs]) => React.createElement(tag, attrs)));
        };

        const Icons = {
            Dashboard: (p) => <IconBridge name="LayoutDashboard" {...p} />,
            Event: (p) => <IconBridge name="Layers" {...p} />,
            Recap: (p) => <IconBridge name="ClipboardEdit" {...p} />,
            Report: (p) => <IconBridge name="FileBarChart" {...p} />,
            Settings: (p) => <IconBridge name="Sliders" {...p} />,
            Plus: (p) => <IconBridge name="Plus" {...p} />,
            Trash: (p) => <IconBridge name="Trash2" {...p} />,
            Edit: (p) => <IconBridge name="Pencil" {...p} />,
            Save: (p) => <IconBridge name="Save" {...p} />,
            Users: (p) => <IconBridge name="Users" {...p} />,
            Trophy: (p) => <IconBridge name="Trophy" {...p} />,
            Download: (p) => <IconBridge name="Download" {...p} />,
            Back: (p) => <IconBridge name="ChevronLeft" {...p} />,
            Check: (p) => <IconBridge name="Check" {...p} />,
            Max: (p) => <IconBridge name="Expand" {...p} />,
            Min: (p) => <IconBridge name="Shrink" {...p} />,
            Upload: (p) => <IconBridge name="UploadCloud" {...p} />,
            Image: (p) => <IconBridge name="Image" {...p} />,
            X: (p) => <IconBridge name="X" {...p} />,
            Loader: (p) => <IconBridge name="Loader2" {...p} />,
            Merge: (p) => <IconBridge name="Combine" {...p} />,
            Lock: (p) => <IconBridge name="Lock" {...p} />,
            Unlock: (p) => <IconBridge name="Unlock" {...p} />,
            ArrowUp: (p) => <IconBridge name="ArrowUp" {...p} />,
            ArrowDown: (p) => <IconBridge name="ArrowDown" {...p} />,
            Sheet: (p) => <IconBridge name="FileSpreadsheet" {...p} />,
            Eye: (p) => <IconBridge name="Eye" {...p} />, 
            Briefcase: (p) => <IconBridge name="Briefcase" {...p} />,
            UserCog: (p) => <IconBridge name="UserCog" {...p} />,
            LogOut: (p) => <IconBridge name="LogOut" {...p} />,
            Key: (p) => <IconBridge name="KeyRound" {...p} />,
            QrCode: (p) => <IconBridge name="QrCode" {...p} />,
            ChevronDown: (p) => <IconBridge name="ChevronDown" {...p} />,
            ChevronRight: (p) => <IconBridge name="ChevronRight" {...p} />,
            Cloud: (p) => <IconBridge name="Cloud" {...p} />,
        };

        const { useState, useEffect, useRef, useCallback } = React;
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const generateToken = () => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };

        // --- UTILS ---
        const resizeImage = (file, maxWidth = 400) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.92));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const generatePDF = (elementId, fileName, callback) => {
            const element = document.getElementById(elementId);
            if(!element) {
                alert("Error: Template PDF tidak ditemukan di DOM. Silakan coba lagi.");
                if(callback) callback();
                return;
            }
            
            window.scrollTo(0, 0);

            const images = element.querySelectorAll('img');
            const promises = Array.from(images).map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
            });

            Promise.all(promises).then(() => {
                const opt = {
                    margin: 5, 
                    filename: `${fileName}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 1.5, useCORS: true, letterRendering: true, scrollY: 0 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                if (typeof html2pdf === 'undefined') {
                    alert("Library PDF belum siap. Periksa koneksi internet Anda.");
                    if(callback) callback();
                    return;
                }

                html2pdf().set(opt).from(element).save()
                    .then(() => { if(callback) callback(); })
                    .catch(err => {
                        console.error("PDF Gen Error:", err);
                        alert("Gagal membuat PDF. Cobalah merefresh halaman.");
                        if(callback) callback();
                    });
            });
        };

        const RANK_PALETTE = ['bg-yellow-100 border-yellow-200', 'bg-red-50 border-red-100', 'bg-orange-100 border-orange-200', 'bg-red-100 border-red-200', 'bg-amber-100 border-amber-200', 'bg-emerald-50 border-emerald-100'];
        const RANK_PALETTE_PDF = ['#fef9c3', '#fef2f2', '#ffedd5', '#fee2e2', '#fef3c7', '#ecfdf5'];

        const getAspectScore = (p, catId, aspId, judgeCount) => {
            const scores = p.scores?.[catId]?.[aspId] || {};
            let total = 0;
            for(let j=1; j<=judgeCount; j++) total += (scores[j] || 0);
            return total / Math.max(1, judgeCount) || 0;
        };

        const getCategoryTotal = (p, cat) => {
            return cat.aspects.reduce((sum, asp) => sum + getAspectScore(p, cat.id, asp.id, cat.judgeCount), 0);
        };

        const getCustomTotal = (p, categories) => {
            return categories.reduce((sum, cat) => sum + getCategoryTotal(p, cat), 0);
        };

        const getProgress = (p, cats) => {
            const categories = Array.isArray(cats) ? cats : [cats];
            let totalSlots = 0;
            let filledSlots = 0;
            categories.forEach(c => {
                const aspectCount = c.aspects.length;
                const judges = c.judgeCount;
                totalSlots += aspectCount * judges;
                c.aspects.forEach(a => {
                    for(let j=1; j<=judges; j++) {
                        const val = p.scores?.[c.id]?.[a.id]?.[j];
                        if(val !== undefined && val !== null && val !== "") filledSlots++;
                    }
                });
            });
            return totalSlots === 0 ? 0 : (filledSlots / totalSlots) * 100;
        };

        const MiniProgressBar = ({ percentage }) => {
            let color = 'bg-red-500';
            if(percentage === 100) color = 'bg-emerald-500';
            else if(percentage > 50) color = 'bg-yellow-400';
            return (
                <div className="flex items-center gap-2" title={`${percentage.toFixed(0)}% Terisi`}>
                    <div className="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden border border-slate-200/50">
                        <div className={`h-full ${color} transition-all duration-500`} style={{width: `${percentage}%`}}></div>
                    </div>
                    {percentage < 100 && <span className="text-[9px] font-bold text-slate-400">{percentage.toFixed(0)}%</span>}
                    {percentage === 100 && <Icons.Check size={10} className="text-emerald-500"/>}
                </div>
            );
        };

        // --- COMPONENTS ---

        const ModalWrapper = ({ children, isOpen, onClose, maxWidth = "max-w-lg" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] modal-overlay overflow-y-auto grid place-items-center p-4" onClick={onClose}>
                    <div className={`relative bg-white w-full ${maxWidth} rounded-[24px] shadow-2xl animate-fade-in my-8 overflow-hidden`} onClick={e => e.stopPropagation()}>
                        {children}
                    </div>
                </div>
            );
        };

        const PreviewModal = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4">
                    <div className="relative animate-fade-in flex flex-col items-center w-full">
                         <div className="flex justify-between items-center w-full max-w-4xl px-4 mb-4 text-white">
                            <h3 className="text-xl font-bold tracking-tight">Dokumen Pratinjau</h3>
                            <button onClick={onClose} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-all"><Icons.X /></button>
                        </div>
                        <div className="preview-modal-content shadow-2xl">
                            <div style={{background: 'white', padding: '15mm 10mm', width: '100%', minHeight: '100%'}}>
                                {children}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const SimpleModal = ({ isOpen, title, type = 'input', message, onConfirm, onCancel, placeholder, defaultValue = '' }) => {
            const [val, setVal] = useState(defaultValue);
            const inputRef = useRef(null);
            
            useEffect(() => {
                if (isOpen) {
                    setVal(defaultValue);
                    setTimeout(() => { if (inputRef.current) inputRef.current.focus(); }, 50);
                }
            }, [isOpen, defaultValue]);

            const isPassword = title ? title.toLowerCase().includes("password") : false;
            if(!isOpen) return null;

            return (
                <ModalWrapper isOpen={isOpen} onClose={onCancel}>
                    <div className="p-8">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-2xl font-extrabold text-slate-900 tracking-tight">{title}</h3>
                            <button onClick={onCancel} className="text-slate-400 hover:text-slate-600 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        {type === 'confirm' ? (
                            <p className="text-slate-600 mb-8 text-lg leading-relaxed">{message}</p>
                        ) : (
                            <div className="mb-8">
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Input Data</label>
                                <input 
                                    ref={inputRef} 
                                    type={isPassword ? "password" : "text"} 
                                    className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-medium text-slate-800" 
                                    placeholder={placeholder} 
                                    value={val} 
                                    onChange={e=>setVal(e.target.value)} 
                                    onKeyDown={e => e.key === 'Enter' && onConfirm(val)} 
                                />
                            </div>
                        )}
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-6 py-3 text-slate-500 hover:bg-slate-100 rounded-xl font-bold transition-all">Batal</button>
                            <button 
                                onClick={() => onConfirm(type==='input'?val:true)} 
                                className={`px-8 py-3 rounded-xl shadow-lg transition-all font-bold text-white ${type === 'confirm' ? 'bg-red-500 hover:bg-red-600 shadow-red-100' : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-100'}`}
                            >
                                {type === 'confirm' ? 'Hapus' : 'Lanjutkan'}
                            </button>
                        </div>
                    </div>
                </ModalWrapper>
            );
        };

        const SidebarLink = ({ active, icon, label, onClick }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 font-semibold group ${active ? 'bg-white text-indigo-700 shadow-md' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}>
                <span className={`${active ? 'text-indigo-600' : 'group-hover:text-indigo-400'} transition-colors`}>{icon}</span> 
                <span className="tracking-tight text-sm">{label}</span>
            </button>
        );

        const LoginView = ({ users, events, settings, onLogin, onParticipantLogin }) => {
            const [mode, setMode] = useState('admin');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [token, setToken] = useState('');
            const [error, setError] = useState('');

            const handleAdminSubmit = (e) => {
                e.preventDefault();
                const user = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);
                if (user) onLogin(user);
                else setError('Username atau password salah');
            };

            const handleTokenSubmit = (e) => {
                e.preventDefault();
                let found = null;
                for (let evt of events) {
                    const p = evt.participants.find(p => p.token === token.toUpperCase());
                    if (p) {
                        found = { event: evt, participant: p };
                        break;
                    }
                }
                if (found) onParticipantLogin(found);
                else setError('Token tidak valid atau tidak ditemukan.');
            };

            return (
                <div className="h-screen w-full overflow-y-auto bg-slate-50 bg-grid-pattern relative overflow-hidden">
                    
                    {/* --- ORNAMEN DINAMIS PROFESIONAL --- */}
                    
                    {/* 1. Large Top-Right Gradient Orb (Purple/Indigo) */}
                    <div className="absolute top-[-10%] right-[-10%] w-[50vw] h-[50vw] bg-gradient-to-br from-purple-600/20 to-indigo-600/20 rounded-full blur-[100px] animate-float"></div>
                    
                    {/* 2. Large Bottom-Left Gradient Orb (Fuchsia/Pink) */}
                    <div className="absolute bottom-[-10%] left-[-10%] w-[50vw] h-[50vw] bg-gradient-to-tr from-fuchsia-600/20 to-pink-500/20 rounded-full blur-[100px] animate-float delay-1000"></div>

                    {/* 3. Floating Geometric Shapes */}
                    <div className="absolute top-[15%] left-[10%] hidden md:block animate-float-slow">
                        <div className="w-20 h-20 border-[6px] border-purple-300/30 rounded-[2rem] transform rotate-12 backdrop-blur-sm"></div>
                    </div>

                    <div className="absolute bottom-[20%] right-[15%] hidden md:block animate-float-slow" style={{animationDelay: '2s'}}>
                        <div className="w-24 h-24 bg-gradient-to-tr from-indigo-500/10 to-purple-500/10 rounded-full backdrop-blur-sm"></div>
                    </div>

                    <div className="absolute top-[40%] right-[5%] hidden md:block animate-float" style={{animationDelay: '4s'}}>
                        <div className="w-4 h-4 bg-fuchsia-400 rounded-full shadow-lg shadow-fuchsia-200"></div>
                    </div>

                    {/* 4. Spinning Donut Shape (Subtle) */}
                    <div className="absolute -bottom-20 -left-20 w-96 h-96 border-[40px] border-purple-100/50 rounded-full animate-spin-slow pointer-events-none"></div>

                    {/* ----------------------------------- */}

                    <div className="min-h-full w-full flex flex-col items-center justify-center py-12 px-4 relative z-10">
                        <div className="glass-card p-10 rounded-[40px] shadow-2xl w-full max-w-md animate-fade-in border-white/50 my-auto">
                            <div className="text-center mb-8">
                                {settings?.appLogo ? (
                                    <img src={settings.appLogo} className="w-24 h-24 object-contain mx-auto mb-6 rounded-2xl shadow-lg bg-white p-2 border border-slate-100" />
                                ) : (
                                    <div className="w-20 h-20 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-3xl flex items-center justify-center font-black text-4xl text-white shadow-xl shadow-purple-500/30 mx-auto mb-6">R</div>
                                )}
                                <h1 className="text-4xl font-black text-slate-900 tracking-tight mb-1">ResRekap</h1>
                                <p className="text-indigo-600 font-bold uppercase tracking-widest text-xs">Sistem Rekap Digital</p>
                                <p className="text-[10px] text-slate-400 font-bold mt-2">by Respati</p>
                            </div>

                            <div className="flex p-1.5 bg-slate-100/80 rounded-2xl mb-8 border border-slate-200/50">
                                <button onClick={()=>{setMode('admin'); setError('');}} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all duration-300 ${mode==='admin' ? 'bg-white shadow-md text-indigo-700' : 'text-slate-400 hover:text-slate-600'}`}>Admin</button>
                                <button onClick={()=>{setMode('token'); setError('');}} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all duration-300 ${mode==='token' ? 'bg-white shadow-md text-indigo-700' : 'text-slate-400 hover:text-slate-600'}`}>Cek Token</button>
                            </div>

                            {mode === 'admin' ? (
                                <form onSubmit={handleAdminSubmit} className="space-y-6 animate-fade-in">
                                    <div>
                                        <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Username</label>
                                        <input autoFocus type="text" className="w-full p-4 bg-white/50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-bold text-slate-800" placeholder="Masukkan username" value={username} onChange={e=>setUsername(e.target.value)}/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Password</label>
                                        <input type="password" className="w-full p-4 bg-white/50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-bold text-slate-800" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)}/>
                                    </div>
                                    {error && <p className="text-red-500 text-sm font-bold text-center bg-red-50 border border-red-100 p-3 rounded-xl">{error}</p>}
                                    <button type="submit" className="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 hover:shadow-indigo-300 hover:scale-[1.02] transition-all active:scale-95">Masuk Aplikasi</button>
                                </form>
                            ) : (
                                <form onSubmit={handleTokenSubmit} className="space-y-6 animate-fade-in">
                                    <div className="text-center pb-2">
                                        <p className="text-sm text-slate-500 font-medium">Masukkan 4 digit kode token peserta untuk mengakses nilai.</p>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Token Peserta</label>
                                        <input autoFocus type="text" className="w-full p-4 bg-white/50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-black text-center text-3xl tracking-[0.5em] text-slate-800 uppercase placeholder:tracking-normal" placeholder="ABCD" maxLength={4} value={token} onChange={e=>setToken(e.target.value)}/>
                                    </div>
                                    {error && <p className="text-red-500 text-sm font-bold text-center bg-red-50 border border-red-100 p-3 rounded-xl">{error}</p>}
                                    <button type="submit" className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black shadow-lg shadow-slate-200 hover:bg-slate-800 transition-all transform hover:scale-[1.02] active:scale-95">Lihat Hasil</button>
                                </form>
                            )}
                        </div>
                        <p className="mt-8 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest opacity-60">© 2026 ResRekap Team</p>
                    </div>
                </div>
            );
        };

        const ParticipantView = ({ data, onBack }) => {
            const { event, participant: p } = data;
            const [collapsedCats, setCollapsedCats] = useState({});

            useEffect(() => {
                const initialCollapse = {};
                event.categories.forEach(c => initialCollapse[c.id] = true);
                setCollapsedCats(initialCollapse);
            }, [event]);

            const toggleCat = (catId) => {
                setCollapsedCats(prev => ({...prev, [catId]: !prev[catId]}));
            };
            
            return (
                <div className="bg-[#f8fafc] h-screen overflow-y-auto animate-fade-in relative">
                    <div className="max-w-4xl mx-auto p-6 pb-20">
                        <button onClick={onBack} className="fixed top-6 left-6 z-50 p-3 bg-white shadow-md border border-slate-200 rounded-full text-slate-500 hover:text-indigo-600 transition-all"><Icons.Back size={24}/></button>
                        
                        <div className="text-center pt-12 mb-10">
                             <div className="inline-block bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full font-bold text-xs uppercase tracking-widest mb-4">Event: {event.name}</div>
                             <h1 className="text-4xl font-black text-slate-900 leading-tight mb-2">{p.name}</h1>
                             <p className="text-slate-400 font-bold tracking-widest">NO. PESERTA: {p.number}</p>
                        </div>

                        <div className="bg-white rounded-[32px] shadow-xl shadow-indigo-100 overflow-hidden mb-12 border border-slate-100">
                             <div className="p-10 text-center bg-slate-900 text-white">
                                 <p className="text-[10px] font-black uppercase tracking-[0.3em] opacity-60 mb-2">Total Akumulasi</p>
                                 <div className="text-7xl font-black tracking-tight">{getCustomTotal(p, event.categories).toFixed(2)}</div>
                             </div>
                        </div>

                        <div className="space-y-4">
                            {event.categories.map(cat => (
                                <div key={cat.id} className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div 
                                        className="px-5 py-4 border-b flex justify-between items-center cursor-pointer transition-colors bg-slate-50/50 hover:bg-slate-100"
                                        onClick={() => toggleCat(cat.id)}
                                    >
                                        <div className="flex items-center gap-3">
                                            {collapsedCats[cat.id] ? <Icons.ChevronRight size={18} className="text-slate-400"/> : <Icons.ChevronDown size={18} className="text-indigo-600"/>}
                                            <h3 className="font-bold text-sm text-slate-700 uppercase tracking-wide">{cat.name}</h3>
                                        </div>
                                        <div className="bg-indigo-600 text-white px-3 py-1 rounded-lg text-[10px] font-black tracking-widest uppercase">
                                            Subtotal: {getCategoryTotal(p, cat).toFixed(2)}
                                        </div>
                                    </div>
                                    
                                    {!collapsedCats[cat.id] && (
                                        <table className="w-full text-left animate-fade-in">
                                            <thead>
                                                <tr className="text-[9px] font-bold text-slate-400 uppercase tracking-widest bg-slate-50/30">
                                                    <th className="px-4 py-3 w-1/3">Kriteria</th>
                                                    {Array.from({length:cat.judgeCount}).map((_,i)=><th key={i} className="px-2 py-3 text-center">Juri {i+1}</th>)}
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {cat.aspects.map(asp => (
                                                    <tr key={asp.id} className="hover:bg-slate-50/50 transition-colors">
                                                        <td className="px-4 py-2 align-middle">
                                                            <div className="font-bold text-slate-700 text-xs leading-tight">{asp.name}</div>
                                                            <div className="text-[9px] text-slate-400 font-medium mt-0.5">Max: {asp.maxScore}</div>
                                                        </td>
                                                        {Array.from({length:cat.judgeCount}).map((_,i) => (
                                                            <td key={i} className="px-2 py-2 text-center">
                                                                <input 
                                                                    type="text"
                                                                    readOnly
                                                                    className="w-16 p-2 text-center rounded-lg font-bold text-sm outline-none bg-slate-50 text-slate-600 border border-transparent cursor-default"
                                                                    value={p.scores?.[cat.id]?.[asp.id]?.[i+1] || '-'} 
                                                                />
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            ))}
                        </div>

                        {event.custom_reports && event.custom_reports.length > 0 && (
                            <div className="mt-12 animate-fade-in">
                                <h3 className="text-xl font-black text-slate-800 tracking-tight mb-6 flex items-center gap-3">
                                    <Icons.Merge className="text-indigo-600" size={24}/>
                                    Lomba Akumulasi
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {event.custom_reports.map(report => {
                                        const reportCats = event.categories.filter(c => report.categoryIds.includes(c.id));
                                        const totalScore = getCustomTotal(p, reportCats);
                                        
                                        return (
                                            <div key={report.id} className="bg-white p-6 rounded-[24px] shadow-sm border border-slate-200">
                                                <h4 className="font-bold text-lg text-slate-800 mb-4 border-b border-slate-100 pb-2">{report.name}</h4>
                                                <div className="space-y-3 mb-6">
                                                    {reportCats.map(cat => (
                                                        <div key={cat.id} className="flex justify-between items-center text-sm">
                                                            <span className="text-slate-500 font-medium flex items-center gap-2">
                                                                <div className="w-1.5 h-1.5 bg-slate-300 rounded-full"></div>
                                                                {cat.name}
                                                            </span>
                                                            <span className="font-bold text-slate-700 bg-slate-50 px-2 py-1 rounded-lg">{getCategoryTotal(p, cat).toFixed(2)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="bg-indigo-50 p-4 rounded-xl flex justify-between items-center">
                                                    <span className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Total Akumulasi</span>
                                                    <span className="text-2xl font-black text-indigo-600">{totalScore.toFixed(2)}</span>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                        <p className="text-center text-xs text-slate-400 font-medium mt-12">Data ini dihasilkan secara otomatis oleh sistem ResRekap.</p>
                    </div>
                </div>
            );
        };

        const AccountManagerView = ({ users, setUsers, modal }) => {
            const addUser = () => {
                modal("Tambah Pengguna Baru", "input", (username) => {
                    if(!username) return alert("Username wajib diisi");
                    if(users.some(u => u.username.toLowerCase() === username.toLowerCase())) return alert("Username sudah ada");
                    
                    modal("Set Password", "input", (password) => {
                        if(!password) return alert("Password wajib diisi");
                        setUsers([...users, { id: generateId(), username, password }]);
                    }, null, "Password user...");
                }, null, "Username baru...");
            };

            const deleteUser = (userToDelete) => {
                if(users.length <= 1) return alert("Tidak bisa menghapus user terakhir.");
                modal("Hapus User?", "confirm", () => {
                    setUsers(users.filter(u => u.username !== userToDelete.username));
                }, `Hapus akses untuk ${userToDelete.username}?`);
            };

            return (
                <div className="animate-fade-in max-w-4xl mx-auto pb-20">
                    <header className="mb-10">
                        <h1 className="text-3xl font-black text-slate-900 tracking-tight leading-none">Manajemen Akun</h1>
                        <p className="text-slate-500 font-medium mt-2 text-sm">Kelola akses pengguna aplikasi.</p>
                    </header>
                    <div className="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100">
                        <div className="flex justify-between items-center mb-8">
                            <h3 className="text-xl font-black text-slate-800 flex items-center gap-3"><Icons.Users size={24} className="text-indigo-600"/> Daftar Pengguna</h3>
                            <button onClick={addUser} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2 text-sm">
                                <Icons.Plus size={16}/> Tambah Akun
                            </button>
                        </div>
                        <div className="overflow-hidden rounded-2xl border border-slate-100">
                            <table className="w-full text-left">
                                <thead className="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                    <tr>
                                        <th className="px-6 py-4">Username</th>
                                        <th className="px-6 py-4">Password</th>
                                        <th className="px-6 py-4 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {users.map((u, i) => (
                                        <tr key={i} className="hover:bg-slate-50/50 transition-colors">
                                            <td className="px-6 py-4 font-bold text-slate-800">{u.username} {i===0 && <span className="ml-2 bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded text-[9px] font-black uppercase">Default</span>}</td>
                                            <td className="px-6 py-4 font-mono text-slate-500 text-sm">••••••</td>
                                            <td className="px-6 py-4 text-right">
                                                <button onClick={()=>deleteUser(u)} className="p-2 text-slate-400 hover:text-red-500 bg-white border border-slate-200 rounded-lg hover:bg-red-50 transition-all">
                                                    <Icons.Trash size={16}/>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const ResRekapApp = () => {
            const [viewState, setViewState] = useState('login'); 
            const [currentUser, setCurrentUser] = useState(null); 
            const [participantViewData, setParticipantViewData] = useState(null); 

            // FIX: Initialize with default user immediately to prevent login lockout
            const [users, setUsers] = useState([{ id: 'default_admin', username: 'Respati', password: '007' }]);
            const [tab, setTab] = useState('dashboard');
            const [events, setEvents] = useState([]);
            const [savedSheets, setSavedSheets] = useState([]);
            const [settings, setSettings] = useState({ organizerName: "Panitia Pelaksana", appLogo: null });
            const [modal, setModal] = useState({ open: false });
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [pdfData, setPdfData] = useState(null);
            const [previewData, setPreviewData] = useState(null); 
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            
            // Firebase Status & Loading Guard
            const [dbStatus, setDbStatus] = useState('syncing'); // syncing, online, offline, error
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [permissionError, setPermissionError] = useState(false); // To prevent spamming alerts
            // NEW: Loading guard to prevent overwriting cloud data with empty local state on boot
            const [isLoaded, setIsLoaded] = useState({ users: false, events: false, settings: false, sheets: false });

            // Warning before closing tab if syncing
            useEffect(() => {
                const handleBeforeUnload = (e) => {
                    if (dbStatus === 'syncing') {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [dbStatus]);

            // --- FIREBASE INTEGRATION LOGIC ---
            useEffect(() => {
                if (!window.firebaseHelpers) return;
                const { signInAnonymously, onAuthStateChanged, collection, doc, onSnapshot } = window.firebaseHelpers;
                const db = window.db;
                const auth = window.auth;

                // 1. Authenticate Anonymously
                signInAnonymously(auth).catch((error) => {
                    console.error("Auth Error:", error);
                    setDbStatus('error');
                    alert("GAGAL LOGIN KE CLOUD!\n\nPastikan 'Anonymous Auth' sudah diaktifkan di Firebase Console > Authentication > Sign-in method.");
                });

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setIsAuthReady(true);
                        setDbStatus('online');

                        // 2. Real-time Listeners
                        // Updated appId namespace to match new project for consistency
                        const appId = "resrekap24_v1"; // Namespace for data
                        // CORRECTED PATH: Removed 'data' to ensure even number of segments for document path
                        const basePath = `artifacts/${appId}/db`;

                        // Listen to Users (stored as single doc for array compatibility)
                        const unsubUsers = onSnapshot(doc(db, basePath, "users_data"), (doc) => {
                            const data = doc.exists() ? doc.data() : null;
                            
                            // Check if valid data exists
                            if(data && Array.isArray(data.list) && data.list.length > 0) {
                                setUsers(data.list);
                            } else {
                                // Critical Fallback: If DB is empty/missing, FORCE default admin
                                console.log("Database user kosong, reset ke default.");
                                const defaultUsers = [{ id: 'default_admin', username: 'Respati', password: '007' }];
                                setUsers(defaultUsers); 
                            }
                            setIsLoaded(prev => ({...prev, users: true}));
                        }, (error) => {
                            console.error("Listener Error:", error);
                            if (error.code === 'permission-denied') {
                                setDbStatus('error');
                            }
                        });

                        // Listen to Events (stored as single doc for array compatibility to keep logic intact)
                        // Note: For large scale apps, events should be a collection, but we keep the "single JSON" logic to not break the code structure requested.
                        const unsubEvents = onSnapshot(doc(db, basePath, "events_data"), (doc) => {
                            if(doc.exists()) setEvents(doc.data().list || []);
                            setIsLoaded(prev => ({...prev, events: true}));
                        });

                        // Listen to Settings
                        const unsubSettings = onSnapshot(doc(db, basePath, "settings_data"), (doc) => {
                            if(doc.exists()) setSettings(doc.data());
                            setIsLoaded(prev => ({...prev, settings: true}));
                        });

                        // Listen to Sheets
                        const unsubSheets = onSnapshot(doc(db, basePath, "sheets_data"), (doc) => {
                            if(doc.exists()) setSavedSheets(doc.data().list || []);
                            setIsLoaded(prev => ({...prev, sheets: true}));
                        });

                        return () => {
                            // unsubUsers(); // Cleanup might cause issues in React StrictMode dev, simplistic approach here
                        };
                    } else {
                        setDbStatus('offline');
                    }
                });
            }, []);

            // 3. Debounced Saving to Firestore
            // Instead of writing to localStorage, we write to Firestore using debouncing
            const saveTimeoutRef = useRef({});

            const debouncedSave = (key, data, isLoadedFlag) => {
                // GUARD: Strictly forbid saving if Auth isn't ready OR if initial data hasn't loaded yet.
                // This prevents overwriting cloud data with empty [] on startup.
                if(!isAuthReady || !isLoadedFlag) return;
                
                setDbStatus('syncing');
                
                if (saveTimeoutRef.current[key]) clearTimeout(saveTimeoutRef.current[key]);

                saveTimeoutRef.current[key] = setTimeout(async () => {
                    const { doc, setDoc } = window.firebaseHelpers;
                    const db = window.db;
                    // Updated appId namespace here too
                    // CORRECTED PATH: Removed 'data' to ensure even number of segments for document path
                    const basePath = `artifacts/resrekap24_v1/db`;
                    
                    try {
                        let payload = data;
                        if(Array.isArray(data)) payload = { list: data };
                        
                        await setDoc(doc(db, basePath, `${key}_data`), payload);
                        setDbStatus('online');
                    } catch (err) {
                        console.error("Save failed", err);
                        setDbStatus('error');
                        if (err.code === 'permission-denied' && !permissionError) {
                            setPermissionError(true);
                            alert("GAGAL MENYIMPAN KE CLOUD!\n\nDatabase menolak akses. Mohon buka Firebase Console > Firestore Database > Rules, dan ubah 'allow read, write: if false;' menjadi 'allow read, write: if true;' atau sesuaikan aturan keamanan.");
                        }
                    }
                }, 1000); // 1 second delay (Reduced from 2s to minimize data loss risk on close)
            };

            // Watch state changes and trigger save with LOAD GUARD
            useEffect(() => { debouncedSave('users', users, isLoaded.users); }, [users, isAuthReady, isLoaded.users]);
            useEffect(() => { debouncedSave('events', events, isLoaded.events); }, [events, isAuthReady, isLoaded.events]);
            useEffect(() => { debouncedSave('settings', settings, isLoaded.settings); }, [settings, isAuthReady, isLoaded.settings]);
            useEffect(() => { debouncedSave('sheets', savedSheets, isLoaded.sheets); }, [savedSheets, isAuthReady, isLoaded.sheets]);
            // --- END FIREBASE LOGIC ---

            const triggerModal = (title, type, cb, msg, ph, defVal = '') => {
                setModal({ open: true, title, type, message: msg, placeholder: ph, defaultValue: defVal,
                    onConfirm: (v) => { 
                        setModal(prev => ({ ...prev, open: false })); 
                        setTimeout(() => cb(v), 150); 
                    },
                    onCancel: () => setModal(prev => ({ ...prev, open: false }))
                });
            };

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => setIsFullscreen(true)).catch(err => console.error(err));
                } else {
                    document.exitFullscreen().then(() => setIsFullscreen(false));
                }
            };

            const handleDownloadPDF = (data, filename) => {
                setPdfData(data); 
                setIsGeneratingPdf(true); 
                setTimeout(() => {
                    generatePDF('pdf-content', filename, () => {
                        setIsGeneratingPdf(false);
                        setPdfData(null);
                    });
                }, 1500); 
            };

            const handlePreviewPDF = (data) => {
                setPreviewData(data);
            };

            const handleLogin = (user) => {
                setCurrentUser(user);
                setViewState('admin');
            };

            const handleParticipantLogin = (data) => {
                setParticipantViewData(data);
                setViewState('participant');
            };

            const handleLogout = () => {
                setViewState('login');
                setCurrentUser(null);
                setParticipantViewData(null);
            };

            if (viewState === 'login') {
                return (
                    <>
                        <LoginView users={users} events={events} settings={settings} onLogin={handleLogin} onParticipantLogin={handleParticipantLogin} />
                        <div className="db-status">
                            <div className={`status-dot status-${dbStatus}`}></div>
                            <span>{dbStatus === 'syncing' ? 'Menyimpan...' : dbStatus === 'online' ? 'Database Terhubung' : dbStatus === 'error' ? 'Akses Ditolak Server' : 'Offline'}</span>
                        </div>
                    </>
                );
            }

            if (viewState === 'participant') {
                return <ParticipantView data={participantViewData} onBack={handleLogout} />;
            }

            return (
                <div className="flex h-screen bg-[#f8fafc] relative">
                    <SimpleModal isOpen={modal.open} {...modal} onCancel={() => setModal({open: false})} />
                    
                    <PreviewModal isOpen={!!previewData} onClose={() => setPreviewData(null)}>
                        {previewData && <PDFContent data={previewData} settings={settings} />}
                    </PreviewModal>

                    {pdfData && (
                        <div id="pdf-fullscreen-container">
                            <div id="pdf-content">
                                <PDFContent data={pdfData} settings={settings} />
                            </div>
                        </div>
                    )}

                    {isGeneratingPdf && (
                        <div id="pdf-loading-overlay">
                            <Icons.Loader size={64} className="text-indigo-600 animate-spin mb-6"/>
                            <h2 className="text-3xl font-extrabold text-slate-900 tracking-tight">Menyusun Dokumen Digital</h2>
                        </div>
                    )}

                    <aside className="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-10">
                        <div className="p-6 flex flex-col items-center justify-center mb-4 transition-all hover:bg-white/5 cursor-pointer" title="Klik untuk Fullscreen" onClick={toggleFullscreen}>
                            <div className="flex items-center gap-4 w-full">
                                {settings.appLogo ? <img src={settings.appLogo} className="w-10 h-10 object-contain bg-white/10 rounded-xl p-1.5 border border-white/5"/> : 
                                <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center font-black text-xl shadow-lg shadow-indigo-500/20">R</div>}
                                <div><h1 className="font-extrabold text-lg tracking-tight leading-none">ResRekap</h1><p className="text-[9px] text-indigo-400 font-bold tracking-[0.2em] uppercase mt-1">v5.9 Pro</p></div>
                            </div>
                        </div>
                        <nav className="flex-1 px-3 space-y-1 overflow-y-auto">
                            <SidebarLink active={tab==='dashboard'} icon={<Icons.Dashboard size={18}/>} label="Dashboard" onClick={()=>setTab('dashboard')}/>
                            <SidebarLink active={tab==='events'} icon={<Icons.Event size={18}/>} label="Struktur Lomba" onClick={()=>setTab('events')}/>
                            <SidebarLink active={tab==='recap'} icon={<Icons.Recap size={18}/>} label="Rekapitulasi Nilai" onClick={()=>setTab('recap')}/>
                            <SidebarLink active={tab==='sheets'} icon={<Icons.Sheet size={18}/>} label="Lembar Penilaian" onClick={()=>setTab('sheets')}/>
                            <SidebarLink active={tab==='report'} icon={<Icons.Report size={18}/>} label="Laporan Akhir" onClick={()=>setTab('report')}/>
                            <SidebarLink active={tab==='accounts'} icon={<Icons.UserCog size={18}/>} label="Manajemen Akun" onClick={()=>setTab('accounts')}/>
                            <SidebarLink active={tab==='settings'} icon={<Icons.Settings size={18}/>} label="Konfigurasi" onClick={()=>setTab('settings')}/>
                        </nav>
                        <div className="p-6">
                            <button onClick={handleLogout} className="w-full py-3 bg-red-500/10 hover:bg-red-500 text-red-400 hover:text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all">
                                <Icons.LogOut size={14}/> Keluar
                            </button>
                            <p className="text-center text-[9px] text-slate-500 font-bold tracking-widest uppercase opacity-40 mt-4">&copy; 2026 ResRekap Team</p>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-auto p-10 bg-pattern">
                        <div className="max-w-7xl mx-auto">
                            {tab === 'dashboard' && <DashboardView events={events} setTab={setTab} />}
                            {tab === 'events' && <EventSettings events={events} setEvents={setEvents} modal={triggerModal} />}
                            {tab === 'recap' && <RecapView events={events} setEvents={setEvents} modal={triggerModal} />}
                            {tab === 'sheets' && <SheetGeneratorView events={events} download={handleDownloadPDF} preview={handlePreviewPDF} savedSheets={savedSheets} setSavedSheets={setSavedSheets} modal={triggerModal}/>} 
                            {tab === 'report' && <ReportView events={events} setEvents={setEvents} settings={settings} download={handleDownloadPDF} modal={triggerModal} />}
                            {tab === 'accounts' && <AccountManagerView users={users} setUsers={setUsers} modal={triggerModal} />}
                            {tab === 'settings' && <AppSettings settings={settings} setSettings={setSettings} events={events} setEvents={setEvents} savedSheets={savedSheets} setSavedSheets={setSavedSheets} modal={triggerModal} />}
                        </div>
                    </main>

                    {/* DB STATUS INDICATOR */}
                    <div className="db-status">
                        <div className={`status-dot status-${dbStatus}`}></div>
                        <span>{dbStatus === 'syncing' ? 'Menyimpan...' : dbStatus === 'online' ? 'Database Terhubung' : dbStatus === 'error' ? 'Akses Ditolak Server' : 'Offline'}</span>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ResRekapApp />);
    </script>
</body>
</html>
